### 服务化性能评估和性能保障

#### 1. 技术评审提纲

**现状：**

* 业务背景：xxx
* 技术背景：系统调用量峰值，最小,最大响应时间)

**需求：**

* 业务需求：改造内容、新需求
* 性能需求：调用量峰值，最小,最大响应时间

**方案描述：**

* 概述

* 详细说明：

  >中间件架构（应用服务器，数据库，缓存，消息队列）
  >逻辑结构（模块划分，通信，信息流，时序）
  >数据架构（数据结构，数据分布，拆分策略，缓存策略，读写分离策略，查询策略，数据一致性策略）
  >异常处理，容灾策略，灰度发布，上线方案，回滚方案

* 性能评估：QPS/TPS (系统吞吐)= (1/rt) * 并发量。

* 方案的优缺点

**方案对比**：

**风险评估：**应对策略

**工作量评估：**联调时间，提测时间，发布时间



#### 2. 非功能质量需求

**核心非功能质量指标：**

* 高性能
* 高用性

* 可伸缩性：垂直伸缩，水平伸缩

* 可扩展性：可插拔，组件重用

* 安全性：数据安全，加密，熔断，防攻击



**非功能质量需求具体指标：**

* 应用服务器：负载均衡，高可用模型，I/O模型，线程池

* 数据库：复制，失效转移，容灾，归档，读写分离，分库分表

* 缓存：复制，失效转移，持久策略，淘汰，线程模型，预热，哈希分片

* 消息队列：复制，失效转移，持久策略。



#### 3. 性能和容量评估

**系统性能指标参考：**

* 普通SATA机械硬盘IOPS 120次/s，一次随机IO：1000/120=8ms
* 高端的SSD的访问速度可以达到普通内存读取速度。 延迟0.1-0.2 ms
* 内存随机读30W次/s，一次随机读取时间：1000/30w=3ns  ,顺序读500w次/s
* 内存读取1MB数据为250ns
* 常见网络带宽1000Mbit/s，读取1MB数据需要10ms左右
* 同一机房网络来回0.5ms，异地机房来回：30-100ms



**通用标准：**

* 容量按照峰值的5倍冗余计算
* 分库分表存储3年数据
* 第三方接口吞吐5000/s



**MySQL：**

* 单端口读：1000/s
* 单端口写：700/s
* 单表容量：5000W



**Redis：**

* 单端口读：7W
* 单端口写：7W
* 单端口内存容量：32GB



**Kafka：**

* 单端口读：30000/s

* 单端口写：5000/s

  

#### 4. 容量评估

**数据库：**

* 读操作吞吐：计算读操作当前容量，评估容量：当前QPS * 5
* 写操作吞吐：计算当前写当前容量，评估容量：当前TPS * 5
* 数据容量：计算当前数据增量，评估容量：当前数量 + 增量 * 3 * 365 (分库分表2指数对齐)



**缓存：**

* 活跃用户数 * key内存大小 * 5倍。



**消息队列：**

* 当前业务每秒写入消息量 * 5倍冗余



**应用服务器：**

* 单机能力dubbo接口(200-400)  rest接口(400-800)QPS的能力来评估。



#### 5.性能测试方案

**明确压测目的：**

* 系统吞吐量目标。 吞吐量 = (1s / 响应时间) * 并发数
* 系统响应时间范围范围。
* 系统可用性100%，系统伸缩性80%（增加机器是否能够线性增加吞吐能力）



**压测场景设计**

* 确认场景需要达到的吞吐QPS
* 基准测试：测试接口在无压力的情况RT
* 根据目标吞吐量，设计梯度加压3个梯度的压测场景。分别计算对应的QPS,RT,并发数



**准备压测环境**

* 压测客户端机器
* 压测脚本



**压测执行** 



**压测工具**

* ab
* **jmeter**
* LoadRunner





