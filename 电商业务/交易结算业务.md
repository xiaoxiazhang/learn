## 结算业务

### (一). 结算业务梳理

#### 结算场景：

- 逆向完结：正常确认收货后，10天后进入逆向完结的时间
- 结算完成后的退款：结算完成后的退款，需要进行结算。
- 订单关闭结算：发货订单关闭【需要结算运费】，预售订单关闭【需要结算押金】

入口代码：FundSettleConsumer#refundSettleListen；FundSettleConsumer#confirmOrderListen



#### 资金成分：

- 商品原价：商家设定的商品市场价格
- 运费金额：商家设定运费承担规则
- 单品优惠：针对商品一级的单品优惠，单品优惠影响单品最终购买价格。如：折扣、一口价等【商家出资】
- 店铺优惠：店铺优惠是店铺设定的活动优惠，如：满(件/元)减、满(件/元)折、满(件/元)包邮。【商家出资】
- 平台优惠：平台出资的优惠，如平台券、身份优惠、会员优惠等。【平台出资】
- G币抵扣：平台虚拟资金货币。【平台出资】

商家实收 = 商品原价 + 商品运费 - 商家出资活动 = 买家商品实付 + 商品运费 + 平台出资活动 ==> 【退款金额最大值是商家实收】



#### 结算数据库模型：

- 结算数据模型：item_order_settle ==> 包含正逆向计算数据【商品实收金额，运费，平台技术服务费，推广服务费】

- 计算资金模型数据：item_order_settle_fund ==> 每笔结算数据包含的资金成分【实付金额 + 运费 + 平台出资优惠】

说明：通过监听消息发起结算，结算成功后进行数据库落库处理。





### **(二). 结算过滤器**

店铺维度：店铺白名单中的订单不结算【xconf配置】

订单类型维度：影子订单类型 & 医美订单类型 

订单关闭的订单：未发货订单关闭的订单不结算。





### **(三).** **结算资金规则：**

 \1. **普通商品资金结算规则：**

  商品实收 = 用户实付 + G币 + 平台优惠 

  运费 = 商品及订单分摊的运费

  平台技术服务费 = 商品实收 * 平台技术服务费比例%

  推广服务费比例 = 商品实收 * 推广服务费比例%



**2. 零售批发商品资金结算规则：**

   商品实收 = 用户实付 + G币 + 平台优惠 

   运费 = 商品及订单分摊的运费

   平台技术服务费 = (商品实收- 综合费) * 平台技术服务费比例% //取值商品及订单extra字段，新的比例结构

   推广服务费比例 = (商品实收- 综合费)  * 推广服务费比例%     //取值商品及订单extra字段，新的比例结构



**3. 定金预售商品资金结算规则(定金已付尾款未付)**

   商品实收 = 定金金额

   运费 = 0     //未发货不产生运费

   平台技术服务费 = 0

   推广服务费比例 = 0